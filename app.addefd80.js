(function(){"use strict";var e={1310:function(e,t,n){var a=n(3751),l=n(641),s=n(33);const o={class:"container"},c={class:"file-input-container"},u={for:"fileInput",class:"file-input-label"},i={for:"txtFileInput",class:"file-input-label",style:{"margin-left":"12px"}},r={class:"file-list"},d={class:"search-container"},f={class:"file-list-content"},h={key:0,class:"select-all-container"},v={class:"select-all-label"},p=["checked"],k={key:1},g={class:"file-checkbox"},m=["onUpdate:modelValue"],b=["onClick"],L={key:2,class:"empty-state"},C={class:"modal-content"},y={class:"modal-header"},_={class:"header-top"},F={class:"header-actions"},w={class:"statistics-note"},x={class:"statistics"},$={class:"stat-item",style:{width:"120px"}},W={class:"stat-value"},E={class:"stat-item",style:{width:"120px"}},R={class:"stat-value"},M={class:"stat-item",style:{width:"120px"}},O={class:"stat-value"},T={class:"token-calc"},A=["disabled"],j={key:0,class:"stat-value"},K={class:"token-value"},S={key:0,class:"search-nav"},U=["disabled"],I=["disabled"],X={class:"modal-body"},D={class:"chat-container"},P={class:"avatar"},N=["innerHTML"],Q={class:"button-container"},V=["disabled"],z=["textContent"];function H(e,t,n,H,J,B){const G=(0,l.g2)("ChatDotRound"),Y=(0,l.g2)("el-icon"),Z=(0,l.g2)("Upload"),q=(0,l.g2)("Document"),ee=(0,l.g2)("Search"),te=(0,l.g2)("el-input"),ne=(0,l.g2)("Select"),ae=(0,l.g2)("ChatLineRound"),le=(0,l.g2)("UploadFilled"),se=(0,l.g2)("InfoFilled"),oe=(0,l.g2)("el-tooltip"),ce=(0,l.g2)("Close"),ue=(0,l.g2)("Loading"),ie=(0,l.g2)("User"),re=(0,l.g2)("Download");return(0,l.uX)(),(0,l.CE)("div",o,[(0,l.Lk)("h1",null,[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(G)])),_:1}),t[11]||(t[11]=(0,l.eW)(" 某种聊天记录"))]),(0,l.Lk)("div",c,[(0,l.Lk)("label",u,[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(Z)])),_:1}),t[12]||(t[12]=(0,l.eW)(" 选择 JSON 文件 "))]),(0,l.Lk)("input",{type:"file",id:"fileInput",accept:".json",onChange:t[0]||(t[0]=(...e)=>H.handleFileChange&&H.handleFileChange(...e))},null,32),(0,l.Lk)("label",i,[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(Z)])),_:1}),t[13]||(t[13]=(0,l.eW)(" 上传聊天txt "))]),(0,l.Lk)("input",{type:"file",id:"txtFileInput",accept:".txt",multiple:"",onChange:t[1]||(t[1]=(...e)=>H.handleTxtFileChange&&H.handleTxtFileChange(...e))},null,32)]),(0,l.Lk)("div",r,[(0,l.Lk)("h2",null,[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(q)])),_:1}),t[14]||(t[14]=(0,l.eW)(" 聊天窗口列表"))]),(0,l.Lk)("div",d,[(0,l.bF)(te,{modelValue:H.searchQuery,"onUpdate:modelValue":t[2]||(t[2]=e=>H.searchQuery=e),placeholder:"搜索聊天记录...","prefix-icon":e.Search,clearable:"",onInput:H.handleSearch},{prefix:(0,l.k6)((()=>[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(ee)])),_:1})])),_:1},8,["modelValue","prefix-icon","onInput"])]),(0,l.Lk)("div",f,[H.lastOutputs.length>0?((0,l.uX)(),(0,l.CE)("div",h,[(0,l.Lk)("label",v,[(0,l.Lk)("input",{type:"checkbox",checked:H.isAllSelected,onChange:t[3]||(t[3]=(...e)=>H.toggleSelectAll&&H.toggleSelectAll(...e))},null,40,p),(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(ne)])),_:1}),t[15]||(t[15]=(0,l.eW)(" 选择所有 "))])])):(0,l.Q3)("",!0),H.lastOutputs.length>0?((0,l.uX)(),(0,l.CE)("ul",k,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(H.filteredOutputs,((e,n)=>((0,l.uX)(),(0,l.CE)("li",{key:n,class:"file-item"},[(0,l.Lk)("label",g,[(0,l.bo)((0,l.Lk)("input",{type:"checkbox","onUpdate:modelValue":e=>H.selectedFiles[n]=e,onChange:t[4]||(t[4]=(...e)=>H.updateSelection&&H.updateSelection(...e))},null,40,m),[[a.lH,H.selectedFiles[n]]])]),(0,l.Lk)("span",{class:"file-name",onClick:t=>H.showFileContent(e)},[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(ae)])),_:1}),(0,l.eW)(" "+(0,s.v_)(e.filename),1)],8,b)])))),128))])):((0,l.uX)(),(0,l.CE)("div",L,[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(le)])),_:1}),t[16]||(t[16]=(0,l.eW)(" 请上传 conversation.json 文件 以查看聊天记录 "))]))])]),H.showModal?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"modal",onClick:t[9]||(t[9]=(0,a.D$)(((...e)=>H.closeModal&&H.closeModal(...e)),["self"]))},[(0,l.Lk)("div",C,[(0,l.Lk)("div",y,[(0,l.Lk)("div",_,[(0,l.Lk)("h3",null,[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(q)])),_:1}),(0,l.eW)(" "+(0,s.v_)(H.currentFile?.filename),1)]),(0,l.Lk)("div",F,[(0,l.Lk)("div",w,[(0,l.bF)(oe,{effect:"dark",content:"精确计算采用GPT官方分词器tokenizer-GPT 4o，不适用于Claude。考虑到聊天内容还包含文件、图片等无法被提取的内容，token计算结果仅供参考。",placement:"bottom"},{default:(0,l.k6)((()=>[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(se)])),_:1})])),_:1})]),(0,l.Lk)("button",{class:"close-button",onClick:t[5]||(t[5]=(...e)=>H.closeModal&&H.closeModal(...e))},[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(ce)])),_:1})])])]),(0,l.Lk)("div",x,[(0,l.Lk)("div",$,[t[17]||(t[17]=(0,l.Lk)("span",{class:"stat-label"},"总字数：",-1)),(0,l.Lk)("span",W,(0,s.v_)(H.statistics.totalTokens),1)]),(0,l.Lk)("div",E,[t[18]||(t[18]=(0,l.Lk)("span",{class:"stat-label"},"AI回复：",-1)),(0,l.Lk)("span",R,(0,s.v_)(H.statistics.assistantCount)+"次",1)]),(0,l.Lk)("div",M,[t[19]||(t[19]=(0,l.Lk)("span",{class:"stat-label"},"用户消息：",-1)),(0,l.Lk)("span",O,(0,s.v_)(H.statistics.userCount)+"次",1)]),(0,l.Lk)("div",T,[(0,l.Lk)("button",{class:"token-button",onClick:t[6]||(t[6]=(...e)=>H.calculateExactTokens&&H.calculateExactTokens(...e)),disabled:H.isCalculating},[H.isCalculating?((0,l.uX)(),(0,l.Wv)(Y,{key:1,class:"is-loading"},{default:(0,l.k6)((()=>[(0,l.bF)(ue)])),_:1})):((0,l.uX)(),(0,l.Wv)(Y,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(se)])),_:1})),(0,l.eW)(" "+(0,s.v_)(H.isCalculating?"计算中...":"计算精确Token"),1)],8,A),null!==H.exactTokens?((0,l.uX)(),(0,l.CE)("span",j,[(0,l.Lk)("span",K,(0,s.v_)(H.exactTokens),1),t[20]||(t[20]=(0,l.Lk)("span",{class:"token-label"},"tokens",-1))])):(0,l.Q3)("",!0)])]),H.searchKeyword&&H.matchCount>0?((0,l.uX)(),(0,l.CE)("div",S,[(0,l.Lk)("button",{onClick:t[7]||(t[7]=(...e)=>H.gotoPrevMatch&&H.gotoPrevMatch(...e)),disabled:H.matchCount<=1},"上一个",8,U),(0,l.Lk)("span",null,(0,s.v_)(H.currentMatchIndex+1)+" / "+(0,s.v_)(H.matchCount),1),(0,l.Lk)("button",{onClick:t[8]||(t[8]=(...e)=>H.gotoNextMatch&&H.gotoNextMatch(...e)),disabled:H.matchCount<=1},"下一个",8,I)])):(0,l.Q3)("",!0)]),(0,l.Lk)("div",X,[(0,l.Lk)("div",D,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(H.chatLines,((e,t)=>((0,l.uX)(),(0,l.CE)("div",{key:t,class:(0,s.C4)(["message-wrapper",H.getMessageClass(e)])},[(0,l.Lk)("div",P,[H.isLeftMessage(e)?((0,l.uX)(),(0,l.Wv)(Y,{key:0},{default:(0,l.k6)((()=>[(0,l.bF)(G)])),_:1})):((0,l.uX)(),(0,l.Wv)(Y,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(ie)])),_:1}))]),(0,l.Lk)("div",{class:"message-bubble",innerHTML:H.getMessageContent(e,t)},null,8,N)],2)))),128))])])])])):(0,l.Q3)("",!0),(0,l.Lk)("div",Q,[(0,l.Lk)("button",{onClick:t[10]||(t[10]=(...e)=>H.handleDownload&&H.handleDownload(...e)),disabled:!H.canDownload},[(0,l.bF)(Y,null,{default:(0,l.k6)((()=>[(0,l.bF)(re)])),_:1}),t[21]||(t[21]=(0,l.eW)(" 导出选中对话 "))],8,V)]),(0,l.Lk)("div",{class:"status",textContent:(0,s.v_)(H.status)},null,8,z)])}n(4114),n(8111),n(1148),n(2489),n(7588),n(1701),n(3579);var J=n(953),B=n(1710),G=n.n(B),Y=n(23),Z=n(163),q=n(8548),ee=n(9190);let te=null;async function ne(){return te||(te=ee.lF),te}async function ae(e){try{return te||await ne(),te(e).length}catch(t){return console.error("Token calculation error:",t),null}}Y.xI.setOptions({breaks:!0,gfm:!0,headerIds:!1,mangle:!1,pedantic:!1,smartLists:!0,smartypants:!1});var le={name:"App",components:{ChatDotRound:q.wUE,Upload:q._OO,Document:q.yoT,Select:q.l6P,ChatLineRound:q.Fv_,UploadFilled:q.m8m,Close:q.bm,Download:q.f5X,User:q.KJW,Search:q.vji,InfoFilled:q.N_H,Loading:q.Rhj},setup(){const e=(0,J.KR)("聊天记录将在这里显示"),t=(0,J.KR)(""),n=(0,J.KR)([]),a=(0,J.KR)([]),s=(0,J.KR)(""),o=(0,J.KR)([]),c=(0,l.EW)((()=>a.value.some((e=>e)))),u=(0,J.KR)(!1),i=(0,J.KR)(null),r=(0,J.KR)(!1),d=(0,J.KR)(null),f=(0,J.KR)(""),h=(0,J.KR)(0),v=(0,J.KR)(0),p=(0,J.KR)([]),k=(0,l.EW)((()=>n.value.length>0&&a.value.every((e=>e))));function g(e){const t=e.target.checked;a.value=n.value.map((()=>t))}function m(){a.value=[...a.value]}function b(e){return e.replace(/[\\/*?:"<>|]/g,"")}function L(e){const t=[];for(const a in e)try{const n=e[a].message,l=n.author?.role||"unknown";if(!["user","assistant"].includes(l))continue;const s=n.content||{};if(s.parts&&s.parts.length){const e=s.parts.join(" ").replace(/^"|"$/g,"").trim();e&&t.push(`【${l}】 ${e}`)}else if("user"===l){const e=n.metadata||{},a=e.user_context_message_data||{},l=(a.about_model_message||"").trim(),s=(a.about_user_message||"").trim();let o=!1;l&&(t.push(`【model_message】 ${l}`),o=!0),s&&(t.push(`【user_message】 ${s}`),o=!0),o&&t.push("-".repeat(80))}}catch(n){console.log(`处理 mapping 内随机键 ${a} 时出错：${n}`)}return t}function C(e){const t=[];if(Array.isArray(e)){const n={};for(const a of e)if(void 0!==a.name&&void 0!==a.chat_messages){const e=a.name||"Undefined",l=a.chat_messages||[];if(!l.length)continue;const s=[];for(const t of l){const e=t.sender,n=t.text;if(e&&n){const t="human"===e?"user":"assistant";s.push(`【${t}】 ${n}`)}}if(s.length){const a=b(e),l=(n[a]||0)+1;n[a]=l;const o=l>1?`${a}_${l}.txt`:`${a}.txt`;t.push({filename:o,content:s.join("\n")})}}else if(void 0!==a.title&&void 0!==a.mapping){const e=a.title||"unknown",l=a.mapping;if(!l)continue;const s=L(l);if(!s.length)continue;const o=b(e)||"unknown",c=(n[o]||0)+1;n[o]=c;const u=c>1?`${o}_${c}.txt`:`${o}.txt`;t.push({filename:u,content:s.join("\n")})}if(0===t.length)throw new Error("未找到有效的对话内容");return t}if("object"!==typeof e||Array.isArray(e))throw new Error("不支持的 JSON 格式");for(const n in e){const a=e[n],l=a.mapping;if(!l)continue;const s=L(l);if(s.length){const e=b(n)||"unknown",a=s.join("\n");t.push({filename:e+".txt",content:a})}}if(0===t.length)throw new Error("未找到有效的对话内容");return t}function y(e){i.value=e,u.value=!0,d.value=null}function _(){u.value=!1,i.value=null}function F(){if(!s.value.trim())return o.value=n.value,void(f.value="");const e=s.value.toLowerCase();o.value=n.value.filter((t=>!!t.filename.toLowerCase().includes(e)||!!t.content.toLowerCase().includes(e))),f.value=s.value.trim()}async function w(e){const l=e.target.files[0];if(!l)return;t.value="正在解析文件...";const s=new FileReader;s.onload=function(e){try{const l=JSON.parse(e.target.result),s=C(l);if(n.value=s,o.value=s,a.value=s.map((()=>!1)),0===s.length)return void Z.nk.error("解析完成，但未找到对话内容");t.value=`解析完成，找到 ${s.length} 个会话`}catch(l){Z.nk.error(l.message||"解析失败"),t.value="解析失败"}},s.readAsText(l,"utf-8")}async function x(){if(a.value.some((e=>e)))try{t.value="正在准备导出...";const e=n.value.filter(((e,t)=>a.value[t]));if(1===e.length){const n=new Blob([e[0].content],{type:"text/plain"}),a=URL.createObjectURL(n),l=document.createElement("a");l.href=a,l.download=e[0].filename,l.click(),URL.revokeObjectURL(a),t.value="导出完成"}else{t.value="正在打包文件，请稍候...";const n=new(G());e.forEach((e=>{n.file(e.filename,e.content)}));const a=await n.generateAsync({type:"blob"}),l=URL.createObjectURL(a),s=document.createElement("a");s.href=l,s.download="chatgpt_dialogues.zip",s.click(),URL.revokeObjectURL(l),t.value=`已导出 ${e.length} 个文件到 chatgpt_dialogues.zip`}}catch(e){t.value="导出失败"}}const $=(0,l.EW)((()=>{if(!i.value?.content)return[];const e=/【(model_message|user_message|assistant|user)】/,t=i.value.content.split("\n"),n=[];let a="",l="";for(const s of t){const t=s.match(e);t?(a&&n.push(`【${l}】${a}`),l=t[1],a=s.replace(e,"").trim()):l&&(a+="\n"+s)}return a&&n.push(`【${l}】${a}`),n.filter((e=>{const t=e.replace(/^【.*?】\s*/,"").trim();return t.length>0}))}));function W(e){return e.startsWith("【assistant】")||e.startsWith("【model_message】")?"message-left":"message-right"}function E(e){return e.startsWith("【assistant】")||e.startsWith("【model_message】")}function R(e,t){let n=e.replace(/^【.*?】\s*/,"").trim();const a=e.startsWith("【user_message】")?n.replace(/-{20,}/g,""):n;let l=(0,Y.xI)(a,{breaks:!0});if(f.value){const e=new RegExp(f.value.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");let n=0;l=l.replace(e,(e=>{const a=`search-match-${t}-${n}`;return n++,`<mark data-match-idx="${n-1}" id="${a}">${e}</mark>`}))}return l.replace(/\s+$/,"").replace(/\n$/,"")}const M=(0,l.EW)((()=>{if(!i.value?.content)return{totalTokens:0,assistantCount:0,userCount:0};const e=i.value.content.split("\n");let t=0,n=0,a=0,l="",s="";const o=e=>{e=e.replace(/https?:\/\/[^\s]+/g,"");let t=0;const n=e.match(/[a-zA-Z]+|[0-9]+|[\u4e00-\u9fa5]|[^\s]/g)||[];for(const a of n)/[a-zA-Z]/.test(a)?t+=Math.ceil(a.length/4):/[0-9]/.test(a)?t+=Math.ceil(a.length/2):/[\u4e00-\u9fa5]/.test(a)?t+=1:(/[\s.,!?;:'"()\-–—…]/.test(a),t+=.5);return Math.round(t)};for(const c of e)c.startsWith("【assistant】")||c.startsWith("【model_message】")?(l&&s&&(t+=o(l),"assistant"===s?n++:a++),s="assistant",l=c.replace(/^【.*?】\s*/,"").trim()):c.startsWith("【user】")||c.startsWith("【user_message】")?(l&&s&&(t+=o(l),"assistant"===s?n++:a++),s="user",l=c.replace(/^【.*?】\s*/,"").trim()):s&&(l+="\n"+c);return l&&s&&(t+=o(l),"assistant"===s?n++:a++),{totalTokens:t,assistantCount:n,userCount:a}}));async function O(){if(i.value?.content){r.value=!0,d.value=null;try{const e=await ae(i.value.content);null!==e&&(d.value=e)}catch(e){console.error("Token calculation failed:",e),Z.nk.error("计算token失败，请稍后重试")}finally{r.value=!1}}}async function T(e){const l=e.target.files;if(!l||!l.length)return;let s=[];for(const t of l)try{const e=await t.text();if(!e.trim()){Z.nk.error(`${t.name} 文件内容为空`);continue}const n=e.split("\n"),a=n.some((e=>{const t=e.trim();return t&&!t.startsWith("-".repeat(20))}));if(!a){Z.nk.error(`${t.name} 未包含有效的对话内容`);continue}const l=n.some((e=>{const t=e.trim();return t&&(t.startsWith("【assistant】")||t.startsWith("【user】")||t.startsWith("【model_message】")||t.startsWith("【user_message】"))}));if(!l){Z.nk.error(`${t.name} 未包含有效的AI或用户对话内容`);continue}s.push({filename:t.name,content:e})}catch(c){Z.nk.error(`读取${t.name}失败`)}s.length&&(n.value=[...n.value,...s],o.value=n.value,a.value=n.value.map((()=>!1)),t.value=`已导入 ${s.length} 个txt文件`),e.target.value=""}function A(){(0,l.dY)((()=>{p.value=Array.from(document.querySelectorAll(".modal-body mark[data-match-idx]")),h.value=p.value.length,h.value>0&&j(v.value)}))}function j(e){p.value[e]&&(p.value[e].scrollIntoView({behavior:"smooth",block:"center"}),p.value.forEach(((t,n)=>{t.classList.toggle("active-match",n===e)})))}function K(){h.value<=1||(v.value=(v.value-1+h.value)%h.value,j(v.value))}function S(){h.value<=1||(v.value=(v.value+1)%h.value,j(v.value))}return(0,l.sV)((async()=>{await(0,l.dY)(),setTimeout((async()=>{try{await ne()}catch(e){console.error("Failed to preload encoder:",e),Z.nk.error("加载失败，请刷新页面重试")}}),100)})),(0,l.wB)([u,f,i],(()=>{u.value&&(v.value=0,A())})),{outputContent:e,status:t,canDownload:c,lastOutputs:n,selectedFiles:a,isAllSelected:k,showModal:u,currentFile:i,searchQuery:s,filteredOutputs:o,statistics:M,handleFileChange:w,handleDownload:x,showFileContent:y,closeModal:_,toggleSelectAll:g,updateSelection:m,chatLines:$,getMessageClass:W,isLeftMessage:E,getMessageContent:R,handleSearch:F,isCalculating:r,exactTokens:d,calculateExactTokens:O,handleTxtFileChange:T,searchKeyword:f,matchCount:h,currentMatchIndex:v,gotoPrevMatch:K,gotoNextMatch:S}}},se=n(6262);const oe=(0,se.A)(le,[["render",H]]);var ce=oe,ue=n(2220);n(4188);const ie=(0,a.Ef)(ce);ie.use(ue.A),ie.mount("#app")}},t={};function n(a){var l=t[a];if(void 0!==l)return l.exports;var s=t[a]={exports:{}};return e[a].call(s.exports,s,s.exports,n),s.exports}n.m=e,function(){var e=[];n.O=function(t,a,l,s){if(!a){var o=1/0;for(r=0;r<e.length;r++){a=e[r][0],l=e[r][1],s=e[r][2];for(var c=!0,u=0;u<a.length;u++)(!1&s||o>=s)&&Object.keys(n.O).every((function(e){return n.O[e](a[u])}))?a.splice(u--,1):(c=!1,s<o&&(o=s));if(c){e.splice(r--,1);var i=l();void 0!==i&&(t=i)}}return t}s=s||0;for(var r=e.length;r>0&&e[r-1][2]>s;r--)e[r]=e[r-1];e[r]=[a,l,s]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={524:0};n.O.j=function(t){return 0===e[t]};var t=function(t,a){var l,s,o=a[0],c=a[1],u=a[2],i=0;if(o.some((function(t){return 0!==e[t]}))){for(l in c)n.o(c,l)&&(n.m[l]=c[l]);if(u)var r=u(n)}for(t&&t(a);i<o.length;i++)s=o[i],n.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return n.O(r)},a=self["webpackChunkchatlog_parser"]=self["webpackChunkchatlog_parser"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=n.O(void 0,[504],(function(){return n(1310)}));a=n.O(a)})();
//# sourceMappingURL=app.addefd80.js.map